{% if post.header.teaser %}
  {% capture teaser %}{{ post.header.teaser }}{% endcapture %}
{% else %}
  {% assign teaser = nil %}
  {% assign content = post.content %}
  
  {% comment %} 提取 Markdown 格式图片 {% endcomment %}
  {% assign md_split = content | split: '![' %}
  {% if md_split.size > 1 %}
    {% assign md_part = md_split[1] | split: '](' %}
    {% if md_part.size > 1 %}
      {% capture teaser %}{{ md_part[1] | split: ')' | first | strip }}{% endcapture %}
    {% endif %}
  {% endif %}
  
  {% comment %} 提取 HTML 格式图片 {% endcomment %}
  {% unless teaser %}
    {% assign html_split = content | split: '<img' %}
    {% if html_split.size > 1 %}
      {% assign img_content = html_split[1] %}
      {% assign src_split = img_content | split: 'src="' %}
      {% if src_split.size > 1 %}
        {% capture teaser %}{{ src_split[1] | split: '"' | first | strip }}{% endcapture %}
      {% endif %}
    {% endif %}
  {% endunless %}
{% endif %}

{% if post.id %}
  {% assign title = post.title | markdownify | remove: "<p>" | remove: "</p>" %}
{% else %}
  {% assign title = post.title %}
{% endif %}

<div class="{{ include.type | default: 'list' }}__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"{% if post.locale %} lang="{{ post.locale }}"{% endif %}>
    
    {% comment %} 网格布局：图片在顶部 {% endcomment %}
    {% if include.type == "grid" and teaser %}
      <div class="archive__item-teaser">
        <img src="{{ teaser | relative_url }}" alt="{{ title }}">
      </div>
    {% endif %}
    
    <h2 class="archive__item-title no_toc" itemprop="headline">
      {% if post.link %}
        <a href="{{ post.link }}">{{ title }}</a> 
        <a href="{{ post.url | relative_url }}" rel="permalink">
          <i class="fas fa-link" aria-hidden="true" title="permalink"></i>
          <span class="sr-only">Permalink</span>
        </a>
      {% else %}
        <a href="{{ post.url | relative_url }}" rel="permalink">{{ title }}</a>
      {% endif %}
    </h2>
    
    {% include page__meta.html type=include.type %}
    
    {% comment %} 摘要内容区域 {% endcomment %}
    {% if post.excerpt or teaser %}
      <div class="archive__item-excerpt" itemprop="description">
        {% comment %} 列表布局：图片作为摘要的开头 {% endcomment %}
        {% if include.type == "list" and teaser %}
          <div class="excerpt-leading-image">
            <a href="{{ post.url | relative_url }}">
              <img src="{{ teaser | relative_url }}" 
                   alt="{{ title }}"
                   loading="lazy">
            </a>
          </div>
        {% endif %}
        
        {% comment %} 摘要文字 {% endcomment %}
        {% if post.excerpt %}
          {{ post.excerpt | markdownify | strip_html | truncate: 160 }}
        {% endif %}
      </div>
    {% endif %}
    
  </article>
</div>

<style>
.archive__item-teaser img {
  width: 100%;
  height: 200px;
  object-fit: cover;
  border-radius: 6px;
  margin-bottom: 15px;
}

/* 摘要区域 */
.archive__item-excerpt {
  margin-top: 10px;
  color: #444;
  line-height: 1.6;
}

/* 摘要开头的图片 */
.excerpt-leading-image {
  margin-bottom: 15px;
}

.excerpt-leading-image a {
  display: block;
  border-radius: 6px;
  overflow: hidden;
}

.excerpt-leading-image img {
  width: 100%;
  height: auto;
  max-height: 200px;
  object-fit: cover;
  transition: transform 0.3s;
}

.excerpt-leading-image:hover img {
  transform: scale(1.02);
}

/* 移动端调整 */
@media (max-width: 768px) {
  .excerpt-leading-image img {
    max-height: 250px;
  }
}
</style>