{% comment %} 第一部分：提取图片 {% endcomment %}
{% if post.header.teaser %}
  {% capture teaser %}{{ post.header.teaser }}{% endcapture %}
{% else %}
  {% assign teaser = nil %}
  {% assign content = post.content %}
  
  {% comment %} 提取 Markdown 格式图片 {% endcomment %}
  {% assign md_split = content | split: '![' %}
  {% if md_split.size > 1 %}
    {% assign md_part = md_split[1] | split: '](' %}
    {% if md_part.size > 1 %}
      {% capture teaser %}{{ md_part[1] | split: ')' | first | strip }}{% endcapture %}
    {% endif %}
  {% endif %}
  
  {% comment %} 提取 HTML 格式图片 {% endcomment %}
  {% unless teaser %}
    {% assign html_split = content | split: '<img' %}
    {% if html_split.size > 1 %}
      {% assign img_content = html_split[1] %}
      {% assign src_split = img_content | split: 'src="' %}
      {% if src_split.size > 1 %}
        {% capture teaser %}{{ src_split[1] | split: '"' | first | strip }}{% endcapture %}
      {% endif %}
    {% endif %}
  {% endunless %}
{% endif %}

{% comment %} 第二部分：准备标题 {% endcomment %}
{% if post.id %}
  {% assign title = post.title | markdownify | remove: "<p>" | remove: "</p>" %}
{% else %}
  {% assign title = post.title %}
{% endif %}

{% comment %} 第三部分：显示内容 {% endcomment %}
<div class="{{ include.type | default: 'list' }}__item">
  <article class="archive__item" itemscope itemtype="https://schema.org/CreativeWork"{% if post.locale %} lang="{{ post.locale }}"{% endif %}>
    
    {% comment %} 标题 - 总是显示 {% endcomment %}
    <h2 class="archive__item-title no_toc" itemprop="headline">
      {% if post.link %}
        <a href="{{ post.link }}">{{ title }}</a> 
        <a href="{{ post.url | relative_url }}" rel="permalink">
          <i class="fas fa-link" aria-hidden="true" title="permalink"></i>
          <span class="sr-only">Permalink</span>
        </a>
      {% else %}
        <a href="{{ post.url | relative_url }}" rel="permalink">{{ title }}</a>
      {% endif %}
    </h2>
    
    {% comment %} 图片 - 如果有则显示 {% endcomment %}
    {% if teaser %}
      <div class="post-image">
        <a href="{{ post.url | relative_url }}">
          <img src="{{ teaser | relative_url }}" 
               alt="{{ title }}"
               loading="lazy">
        </a>
      </div>
    {% endif %}
    
    {% comment %} 元数据和摘要 {% endcomment %}
    {% include page__meta.html type=include.type %}
    
    {% if post.excerpt %}
      <p class="archive__item-excerpt" itemprop="description">
        {{ post.excerpt | markdownify | strip_html | truncate: 160 }}
      </p>
    {% endif %}
    
  </article>
</div>

<style>
.post-image {
  margin: 12px 0;
  border-radius: 6px;
  overflow: hidden;
  max-height: 250px;
}

.post-image img {
  width: 100%;
  height: auto;
  max-height: 250px;
  object-fit: cover;
  transition: transform 0.3s;
}

.post-image:hover img {
  transform: scale(1.03);
}

@media (max-width: 768px) {
  .post-image {
    max-height: 180px;
  }
  
  .post-image img {
    max-height: 180px;
  }
}
</style>